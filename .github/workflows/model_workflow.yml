name: QA Playground Workflow LLM Testing

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
    branches:
      - main

jobs:
  inference:
    permissions:
      models: read
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Generate diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          git --no-pager diff "$BASE_SHA...$HEAD_SHA" > diff.txt

      - name: Read diff into output
        id: diff_file
        run: |
          content="$(cat diff.txt)"
          {
            echo 'diff<<EOF'
            echo "$content"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"    

      - name: Analyze regression impact
        id: impact
        uses: actions/ai-inference@v2.0.1
        with:
          model: openai/gpt-4o
          system-prompt: |
            You are a senior QA Automation Engineer.
            Your task is to read a git diff and produce a precise list of:
            - functional areas impacted
            - regression risks
            You should generate a checklist of areas to test.
            Respond in concise bullet points.
          prompt: |
            Here is the git diff to analyze:

            ${{ steps.diff_file.outputs.diff }}
          max-tokens: 2048

      - name: Show output
        run: |
          echo "===== REGRESSION IMPACT ====="
          echo "${{ steps.impact.outputs.response }}"
          echo "============================="